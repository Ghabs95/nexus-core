<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nexus Workflow Visualizer</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif; background: #0d1117; color: #e6edf3; height: 100vh; display: flex; flex-direction: column; }
    header { padding: 12px 20px; background: #161b22; border-bottom: 1px solid #30363d; display: flex; align-items: center; gap: 16px; }
    header h1 { font-size: 1.1rem; font-weight: 600; }
    #status-dot { width: 10px; height: 10px; border-radius: 50%; background: #f85149; flex-shrink: 0; }
    #status-dot.connected { background: #3fb950; }
    #status-text { font-size: 0.8rem; color: #8b949e; }
    #main { display: flex; flex: 1; overflow: hidden; }
    #cy { flex: 1; background: #0d1117; }
    #sidebar { width: 300px; background: #161b22; border-left: 1px solid #30363d; display: flex; flex-direction: column; }
    #sidebar h2 { padding: 12px 16px; font-size: 0.85rem; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #30363d; }
    #event-log { flex: 1; overflow-y: auto; padding: 8px; }
    .event-item { padding: 8px 10px; margin: 4px 0; border-radius: 6px; font-size: 0.8rem; border-left: 3px solid #58a6ff; background: #1c2128; }
    .event-item.agent_registered { border-color: #3fb950; }
    .event-item.workflow_mapped { border-color: #d29922; }
    .event-item .event-time { font-size: 0.7rem; color: #8b949e; margin-bottom: 3px; }
    .event-item .event-body { color: #e6edf3; word-break: break-word; }
    #controls { padding: 12px 16px; border-top: 1px solid #30363d; display: flex; gap: 8px; }
    button { flex: 1; padding: 6px 10px; border: 1px solid #30363d; border-radius: 6px; background: #21262d; color: #e6edf3; cursor: pointer; font-size: 0.8rem; }
    button:hover { background: #30363d; }
  </style>
</head>
<body>
<header>
  <div id="status-dot"></div>
  <h1>Nexus Workflow Visualizer</h1>
  <span id="status-text">Connecting…</span>
</header>
<div id="main">
  <div id="cy"></div>
  <div id="sidebar">
    <h2>Live Events</h2>
    <div id="event-log"></div>
    <div id="controls">
      <button onclick="cy.fit()">Fit</button>
      <button onclick="clearGraph()">Clear</button>
    </div>
  </div>
</div>
<script>
// ---- Graph ----
const cy = cytoscape({
  container: document.getElementById('cy'),
  style: [
    { selector: 'node', style: {
        'background-color': '#21262d',
        'border-color': '#58a6ff',
        'border-width': 2,
        'color': '#e6edf3',
        'label': 'data(label)',
        'text-valign': 'center',
        'text-halign': 'center',
        'font-size': '11px',
        'width': 100, 'height': 40,
        'shape': 'round-rectangle',
        'text-wrap': 'wrap',
        'text-max-width': '90px',
    }},
    { selector: 'node.workflow', style: { 'background-color': '#1f2d1f', 'border-color': '#3fb950', 'border-width': 2 }},
    { selector: 'node.agent', style: { 'background-color': '#1e2538', 'border-color': '#58a6ff' }},
    { selector: 'edge', style: {
        'width': 2,
        'line-color': '#30363d',
        'target-arrow-color': '#30363d',
        'target-arrow-shape': 'triangle',
        'curve-style': 'bezier',
        'label': 'data(label)',
        'font-size': '9px',
        'color': '#8b949e',
        'text-background-color': '#0d1117',
        'text-background-opacity': 1,
        'text-background-padding': '2px',
    }},
  ],
  layout: { name: 'cose', padding: 30 },
  elements: [],
});

function ensureNode(id, label, cls) {
  if (!cy.getElementById(id).length) {
    cy.add({ data: { id, label }, classes: cls });
    relayout();
  }
}

function ensureEdge(source, target, label) {
  const eid = `${source}->${target}`;
  if (!cy.getElementById(eid).length) {
    cy.add({ data: { id: eid, source, target, label } });
    relayout();
  }
}

let layoutTimer = null;
function relayout() {
  clearTimeout(layoutTimer);
  layoutTimer = setTimeout(() => {
    cy.layout({ name: 'cose', animate: true, animationDuration: 400, padding: 30 }).run();
  }, 300);
}

function clearGraph() {
  cy.elements().remove();
}

// ---- Event log ----
function logEvent(type, data) {
  const log = document.getElementById('event-log');
  const item = document.createElement('div');
  item.className = `event-item ${type}`;
  const time = new Date().toLocaleTimeString();
  item.innerHTML = `<div class="event-time">${time} — <strong>${type}</strong></div><div class="event-body">${JSON.stringify(data)}</div>`;
  log.prepend(item);
  // Cap log to 100 items
  while (log.children.length > 100) log.removeChild(log.lastChild);
}

// ---- SocketIO ----
const socket = io('/visualizer');

socket.on('connect', () => {
  document.getElementById('status-dot').classList.add('connected');
  document.getElementById('status-text').textContent = 'Connected';
});

socket.on('disconnect', () => {
  document.getElementById('status-dot').classList.remove('connected');
  document.getElementById('status-text').textContent = 'Disconnected — reconnecting…';
});

socket.on('agent_registered', (data) => {
  logEvent('agent_registered', data);
  const issueId = `issue-${data.issue}`;
  const agentId = `agent-${data.issue}-${data.agent}`;
  ensureNode(issueId, `Issue #${data.issue}`, 'workflow');
  ensureNode(agentId, data.agent, 'agent');
  ensureEdge(issueId, agentId, 'launched');
});

socket.on('workflow_mapped', (data) => {
  logEvent('workflow_mapped', data);
  const issueId = `issue-${data.issue}`;
  const wfId = `wf-${data.workflow_id}`;
  ensureNode(issueId, `Issue #${data.issue}`, 'workflow');
  ensureNode(wfId, data.workflow_id, 'workflow');
  ensureEdge(issueId, wfId, 'workflow');
});
</script>
</body>
</html>
